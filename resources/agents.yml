# =============================================================================
# Step 6: Deploy Agents (Orchestrator & Specialists) â€” AgentBricks
# =============================================================================
# Single task runs AgentBricks agents: LangGraph + UC tools (same five specialists
# + orchestrator). Orchestrator runs all five in sequence and synthesizes.
# LLM: Mosaic AI (Model Serving). Tools: Unity Catalog functions (Job 3 create_uc_agent_tools).
#
# UC agent tool functions must exist in catalog.schema (Job 3) before running this job.
# =============================================================================

resources:
  jobs:
    "job_6_deploy_agents":
      name: "[${var.environment}] 6. Deploy Agents (Orchestrator & Specialists)"
      description: "Run AgentBricks agents (LangGraph + UC tools): orchestrator coordinates Smart Routing, Smart Retry, Decline Analyst, Risk Assessor, and Performance Recommender. Single task runs one comprehensive analysis. Requires UC agent tools (Job 3 create_uc_agent_tools)."
      max_concurrent_runs: 1
      environments:
        - environment_key: lakebase_sdk
          spec:
            environment_version: "4"
            dependencies:
              - "databricks-sdk==0.86.0"
              - "databricks-langchain==0.15.0"
              - "unitycatalog-langchain[databricks]==0.3.0"
              - "langgraph==1.0.8"
              - "langchain-core==1.2.11"
              - "mlflow==3.9.0"
              - "psycopg[binary]==3.3.2"
      tasks:
        - task_key: run_agent_framework
          description: "Run AgentBricks (orchestrator + all specialists) with one comprehensive query"
          environment_key: lakebase_sdk
          notebook_task:
            notebook_path: ${workspace.root_path}/src/payment_analysis/agents/langgraph_agents
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              llm_endpoint: "databricks-meta-llama-3-3-70b-instruct"
              query: "Run comprehensive payment analysis: routing, retries, declines, risk, and performance optimizations."
              agent_role: "orchestrator"
          timeout_seconds: 3600
        - task_key: register_agentbricks
          description: "Log and register AgentBricks agents to Unity Catalog (MLflow) for Model Serving / Agents UI"
          environment_key: lakebase_sdk
          notebook_task:
            notebook_path: ${workspace.root_path}/src/payment_analysis/agents/agentbricks_register
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              model_registry_schema: "agents"
              llm_endpoint: "databricks-meta-llama-3-3-70b-instruct"
          timeout_seconds: 1800
      schedule:
        quartz_cron_expression: "0 0 7 ? * MON"
        timezone_id: "UTC"
        pause_status: "PAUSED"
      tags:
        environment: ${var.environment}
        project: payment-analysis
        component: ai-agents
        step: "6"
        domain: payment-analytics
