# =============================================================================
# Model Serving Endpoints & Mosaic AI Gateway
# =============================================================================
# Six endpoints: payment-analysis-orchestrator (supervisor), decline_analyst, approval propensity,
# risk scoring, smart routing, smart retry. Orchestrator is registered to catalog.agents (Job 6 task 2).
# Enable this include after models/agents are trained and registered in Unity Catalog.
# =============================================================================

resources:
  model_serving_endpoints:
    # Supervisor / Orchestrator (AgentBricks). Set ORCHESTRATOR_SERVING_ENDPOINT to this name so app chat uses it.
    payment_analysis_orchestrator_endpoint:
      name: "payment-analysis-orchestrator"
      config:
        served_entities:
          - entity_name: "${var.catalog}.agents.orchestrator"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
            environment_vars: { ENABLE_MLFLOW_TRACING: "true" }
        traffic_config:
          routes: [{ served_model_name: "orchestrator-1", traffic_percentage: 100 }]
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 60 }]
        usage_tracking_config: { enabled: true }

    # Decline analyst agent (LangGraph); register in catalog.schema before deploy
    decline_analyst_endpoint:
      name: "decline-analyst-${var.environment}"
      config:
        served_entities:
          - entity_name: "${var.catalog}.${var.schema}.decline_analyst"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
            environment_vars: { ENABLE_MLFLOW_TRACING: "true" }
        traffic_config:
          routes: [{ served_model_name: "decline_analyst-1", traffic_percentage: 100 }]
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 100 }]
        usage_tracking_config: { enabled: true }

    # Predicts transaction approval probability
    approval_propensity_endpoint:
      name: "approval-propensity-${var.environment}"
      config:
        served_entities:
          - entity_name: "${var.catalog}.${var.schema}.approval_propensity_model"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
            environment_vars: { ENABLE_MLFLOW_TRACING: "true" }
        traffic_config:
          routes: [{ served_model_name: "approval_propensity_model-1", traffic_percentage: 100 }]
        auto_capture_config:
          catalog_name: ${var.catalog}
          schema_name: ${var.schema}
          table_name_prefix: "approval_propensity_inf"
          enabled: true
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 100 }]
        usage_tracking_config: { enabled: true }

    # Fraud risk scoring with PII guardrails
    risk_scoring_endpoint:
      name: "risk-scoring-${var.environment}"
      config:
        served_entities:
          - entity_name: "${var.catalog}.${var.schema}.risk_scoring_model"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
            environment_vars: { ENABLE_MLFLOW_TRACING: "true" }
        traffic_config:
          routes: [{ served_model_name: "risk_scoring_model-1", traffic_percentage: 100 }]
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 100 }]
        guardrails:
          input: { pii: { behavior: "BLOCK" } }
          output: { safety: true, pii: { behavior: "MASK" } }
        usage_tracking_config: { enabled: true }

    # Optimal payment route recommendation
    smart_routing_endpoint:
      name: "smart-routing-${var.environment}"
      config:
        served_entities:
          - entity_name: "${var.catalog}.${var.schema}.smart_routing_policy"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
        traffic_config:
          routes: [{ served_model_name: "smart_routing_policy-1", traffic_percentage: 100 }]
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 200 }]
        usage_tracking_config: { enabled: true }

    # Retry success likelihood and recovery
    smart_retry_endpoint:
      name: "smart-retry-${var.environment}"
      config:
        served_entities:
          - entity_name: "${var.catalog}.${var.schema}.smart_retry_policy"
            entity_version: "1"
            workload_size: "Small"
            scale_to_zero_enabled: true
            workload_type: "CPU"
        traffic_config:
          routes: [{ served_model_name: "smart_retry_policy-1", traffic_percentage: 100 }]
      ai_gateway:
        rate_limits: [{ key: "user", renewal_period: "minute", calls: 200 }]
        usage_tracking_config: { enabled: true }
