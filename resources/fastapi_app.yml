# Databricks App resource: name, source path, and resource bindings.
# Configuration: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/configuration
# Authorization: https://docs.databricks.com/aws/en/dev-tools/databricks-apps/auth
# Runtime: app.yml at project root (command, env). source_code_path = where bundle sync uploads files (workspace.file_path).
#
# Environment (Workspace → Apps → payment-analysis → Edit → Environment):
#   PGAPPNAME               — Required. Match var.lakebase_instance_name (dev: payment-analysis-db-dev).
#   DATABRICKS_WAREHOUSE_ID — Required for SQL/analytics (from sql-warehouse binding).
#   DATABRICKS_HOST         — Optional when opened from Compute → Apps (workspace URL derived from request headers).
#   DATABRICKS_TOKEN        — Optional when using user authorization: open from Compute → Apps so token is forwarded (x-forwarded-access-token). Do not set DATABRICKS_CLIENT_ID/SECRET when using forwarded user token.

resources:
  apps:
    payment_analysis_app:
      name: payment-analysis
      source_code_path: ${workspace.file_path}
      description: Payment Approval Optimization Platform – dashboards, rules, decisioning, ML models, and agent jobs.
      resources:
        - name: database
          description: Lakebase instance for rules, experiments, incidents, ML features
          database:
            instance_name: ${var.lakebase_instance_name}
            database_name: ${var.lakebase_database_name}
            permission: CAN_CONNECT_AND_CREATE
        - name: sql-warehouse
          description: SQL warehouse for analytics, app_config, gold views
          sql_warehouse:
            id: ${resources.sql_warehouses.payment_analysis_warehouse.id}
            permission: CAN_USE
        # Genie: commented out so deploy succeeds when genie_space_id is empty (required field). Uncomment and set --var genie_space_id=<uuid> to bind "Approvals domain expert".
        # - name: genie-space
        #   description: Genie space for natural language analytics (Ask Data)
        #   genie_space:
        #     name: "Approvals domain expert"
        #     space_id: ${var.genie_space_id}
        #     permission: CAN_RUN
        # Optional secret: uncomment and set scope/key if the app needs secrets
        # - name: app-secrets
        #   description: Secret scope for API keys or other sensitive config
        #   secret:
        #     scope: "payment-analysis"
        #     key: "api-key"
        #     permission: READ
        # UC volume: uncomment after schema/volume exist (e.g. after first full deploy)
        # - name: volume-reports
        #   description: UC volume for reports and Genie config
        #   uc_securable:
        #     securable_type: VOLUME
        #     securable_full_name: "${var.catalog}.${var.schema}.reports"
        #     permission: READ_VOLUME
        # Jobs used by UI (Setup & Run). Order matches execution steps: bootstrap → vector search → gold views → simulator → optional streaming (realtime pipeline + stream processor) → ETL → ML → Genie → agents → publish dashboards.
        - name: job-lakehouse-bootstrap
          description: Lakehouse bootstrap (app_config, rules, recommendations)
          job:
            id: ${resources.jobs.lakehouse_bootstrap_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-vector-search-index
          description: Create Vector Search index for similar-transaction lookup
          job:
            id: ${resources.jobs.vector_search_index_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-gold-views
          description: Create gold views
          job:
            id: ${resources.jobs.create_gold_views_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-simulator
          description: Transaction stream simulator
          job:
            id: ${resources.jobs.transaction_stream_simulator.id}
            permission: CAN_MANAGE_RUN
        - name: job-train-ml
          description: Train ML models
          job:
            id: ${resources.jobs.train_ml_models_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-genie-sync
          description: Genie space sync
          job:
            id: ${resources.jobs.genie_sync_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-test-agent
          description: Test agent framework
          job:
            id: ${resources.jobs.test_agent_framework_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-orchestrator-agent
          description: Orchestrator agent
          job:
            id: ${resources.jobs.orchestrator_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-smart-routing-agent
          description: Smart routing agent
          job:
            id: ${resources.jobs.smart_routing_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-smart-retry-agent
          description: Smart retry agent
          job:
            id: ${resources.jobs.smart_retry_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-decline-analyst
          description: Decline analyst agent
          job:
            id: ${resources.jobs.decline_analyst_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-risk-assessor-agent
          description: Risk assessor agent
          job:
            id: ${resources.jobs.risk_assessor_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-perf-recommender-agent
          description: Performance recommender agent
          job:
            id: ${resources.jobs.performance_recommender_agent_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-publish-dashboards
          description: Publish dashboards (embed credentials for app UI)
          job:
            id: ${resources.jobs.publish_dashboards_job.id}
            permission: CAN_MANAGE_RUN
        - name: job-stream-processor
          description: Continuous stream processor
          job:
            id: ${resources.jobs.continuous_stream_processor.id}
            permission: CAN_MANAGE_RUN
        # Model serving: commented out so deploy succeeds when model_serving.yml is not included (endpoints don't exist). Uncomment only after including resources/model_serving.yml in databricks.yml.
        # - name: serving-approval-prop
        #   description: Approval propensity model endpoint
        #   serving_endpoint:
        #     name: "approval-propensity-${var.environment}"
        #     permission: CAN_QUERY
        # - name: serving-risk-scoring
        #   description: Risk scoring model endpoint
        #   serving_endpoint:
        #     name: "risk-scoring-${var.environment}"
        #     permission: CAN_QUERY
        # - name: serving-smart-routing
        #   description: Smart routing model endpoint
        #   serving_endpoint:
        #     name: "smart-routing-${var.environment}"
        #     permission: CAN_QUERY
        # - name: serving-smart-retry
        #   description: Smart retry model endpoint
        #   serving_endpoint:
        #     name: "smart-retry-${var.environment}"
        #     permission: CAN_QUERY
      # PGAPPNAME in app.yaml and app.yml at project root must match var.lakebase_instance_name (dev: payment-analysis-db-dev).
