import{c as C,j as e,U as E,r as x,V as L,X as g,t as T,y as _,z as f,E as N,B as d,H as b,h as M,I as R}from"./index-CxQcrJOo.js";import{I as o}from"./input-B4Jz6yEC.js";const A=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],P=C("pencil",A);const F=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],I=C("plus",F);const q=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Q=C("trash-2",q);async function z(r){const i=new URLSearchParams;r?.rule_type&&i.set("rule_type",r.rule_type),r?.active_only&&i.set("active_only","true");const l=`/api/rules${i.toString()?`?${i}`:""}`,c=await fetch(l);if(!c.ok)throw new Error(c.statusText);return c.json()}async function D(r){const i=await fetch("/api/rules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok){const l=await i.text();throw new Error(l||i.statusText)}return i.json()}async function $(r,i){const l=await fetch(`/api/rules/${r}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!l.ok){const c=await l.text();throw new Error(c||l.statusText)}return l.json()}async function O(r){const i=await fetch(`/api/rules/${r}`,{method:"DELETE"});if(!i.ok)throw new Error(i.statusText)}const k=[{value:"authentication",label:"Authentication"},{value:"retry",label:"Retry"},{value:"routing",label:"Routing"}];function H(){const r=E(),[i,l]=x.useState(""),[c,h]=x.useState(!1),[w,p]=x.useState(null),[s,n]=x.useState({name:"",rule_type:"authentication",action_summary:"",condition_expression:"",priority:100,is_active:!0}),y=L({queryKey:["/api/rules",i],queryFn:()=>z(i?{rule_type:i}:void 0)}),u=g({mutationFn:D,onSuccess:()=>{r.invalidateQueries({queryKey:["/api/rules"]}),h(!1),n({name:"",rule_type:"authentication",action_summary:"",condition_expression:"",priority:100,is_active:!0})}}),m=g({mutationFn:({ruleId:t,payload:a})=>$(t,a),onSuccess:()=>{r.invalidateQueries({queryKey:["/api/rules"]}),p(null)}}),S=g({mutationFn:O,onSuccess:()=>r.invalidateQueries({queryKey:["/api/rules"]})}),v=y.data??[],j=y.isLoading;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold flex items-center gap-2",children:[e.jsx(T,{className:"w-6 h-6"}),"Approval rules (Lakehouse)"]}),e.jsx("p",{className:"mt-1 text-sm font-medium text-primary",children:"Conditions and actions that automatically accelerate approval rates or constrain risk"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Rules are used by the decision engine and AI agents. Write them into the Lakehouse (run lakehouse_bootstrap.sql in Setup & Run step 4)."})]}),e.jsxs(_,{children:[e.jsxs(f,{children:[e.jsx(N,{children:"Rules"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsxs("select",{className:"rounded-md border bg-background px-3 py-1.5 text-sm",value:i,onChange:t=>l(t.target.value),children:[e.jsx("option",{value:"",children:"All types"}),k.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsxs(d,{size:"sm",onClick:()=>h(!0),children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Add rule"]})]})]}),e.jsxs(b,{children:[y.isError&&e.jsx("p",{className:"text-sm text-destructive",children:"Failed to load rules. Complete Setup & Run step 4 (run lakehouse_bootstrap.sql in SQL Warehouse) and ensure Databricks connection is configured in Setup & Run."}),j&&e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsx(M,{className:"h-20 w-full"},t))}),!j&&v.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No rules yet. Run lakehouse_bootstrap.sql (Setup & Run step 4), then add rules here. ML and AI agents will use them."}),!j&&v.length>0&&e.jsx("ul",{className:"space-y-3",children:v.map(t=>e.jsxs("li",{className:"rounded-lg border p-4 flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsx(R,{variant:"secondary",className:"ml-2",children:t.rule_type}),!t.is_active&&e.jsx(R,{variant:"outline",className:"ml-2",children:"Inactive"}),e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["priority ",t.priority]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{p(t.id),n({name:t.name,rule_type:t.rule_type,action_summary:t.action_summary,condition_expression:t.condition_expression??"",priority:t.priority,is_active:t.is_active})},children:e.jsx(P,{className:"w-4 h-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>{confirm("Delete this rule?")&&S.mutate(t.id)},disabled:S.isPending,children:e.jsx(Q,{className:"w-4 h-4 text-destructive"})})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.action_summary}),t.condition_expression&&e.jsx("p",{className:"text-xs text-muted-foreground font-mono truncate",children:t.condition_expression})]},t.id))})]})]}),c&&e.jsxs(_,{children:[e.jsx(f,{children:e.jsx(N,{children:"Add rule to Lakehouse"})}),e.jsxs(b,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Name"}),e.jsx(o,{value:s.name,onChange:t=>n(a=>({...a,name:t.target.value})),placeholder:"e.g. Low risk skip 3DS"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Rule type"}),e.jsx("select",{className:"w-full rounded-md border bg-background px-3 py-2 text-sm",value:s.rule_type,onChange:t=>n(a=>({...a,rule_type:t.target.value})),children:k.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Action summary"}),e.jsx(o,{value:s.action_summary,onChange:t=>n(a=>({...a,action_summary:t.target.value})),placeholder:"e.g. Route standard; no 3DS for low risk"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Condition (optional, JSON or text)"}),e.jsx(o,{value:s.condition_expression,onChange:t=>n(a=>({...a,condition_expression:t.target.value})),placeholder:'e.g. {"risk_tier":"LOW"}'})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Priority (lower = higher)"}),e.jsx(o,{type:"number",value:s.priority,onChange:t=>n(a=>({...a,priority:Number(t.target.value)||100}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"is_active",checked:s.is_active,onChange:t=>n(a=>({...a,is_active:t.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:()=>u.mutate({name:s.name,rule_type:s.rule_type,action_summary:s.action_summary,condition_expression:s.condition_expression||void 0,priority:s.priority,is_active:s.is_active}),disabled:!s.name.trim()||!s.action_summary.trim()||u.isPending,children:"Save to Lakehouse"}),e.jsx(d,{variant:"outline",onClick:()=>h(!1),children:"Cancel"})]}),u.isError&&e.jsx("p",{className:"text-sm text-destructive",children:String(u.error)})]})]}),w&&e.jsxs(_,{children:[e.jsx(f,{children:e.jsx(N,{children:"Edit rule"})}),e.jsxs(b,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Name"}),e.jsx(o,{value:s.name,onChange:t=>n(a=>({...a,name:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Rule type"}),e.jsx("select",{className:"w-full rounded-md border bg-background px-3 py-2 text-sm",value:s.rule_type,onChange:t=>n(a=>({...a,rule_type:t.target.value})),children:k.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Action summary"}),e.jsx(o,{value:s.action_summary,onChange:t=>n(a=>({...a,action_summary:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Condition (optional)"}),e.jsx(o,{value:s.condition_expression,onChange:t=>n(a=>({...a,condition_expression:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm text-muted-foreground",children:"Priority"}),e.jsx(o,{type:"number",value:s.priority,onChange:t=>n(a=>({...a,priority:Number(t.target.value)||100}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"edit_is_active",checked:s.is_active,onChange:t=>n(a=>({...a,is_active:t.target.checked}))}),e.jsx("label",{htmlFor:"edit_is_active",className:"text-sm",children:"Active"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{onClick:()=>m.mutate({ruleId:w,payload:{name:s.name,rule_type:s.rule_type,action_summary:s.action_summary,condition_expression:s.condition_expression||void 0,priority:s.priority,is_active:s.is_active}}),disabled:!s.name.trim()||!s.action_summary.trim()||m.isPending,children:"Update"}),e.jsx(d,{variant:"outline",onClick:()=>p(null),children:"Cancel"})]}),m.isError&&e.jsx("p",{className:"text-sm text-destructive",children:String(m.error)})]})]})]})}const B=()=>e.jsx(H,{});export{B as component};
